<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cipher Decoder (Shift 3)</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
      background-color: #000;
    }
    
    .container {
      display: flex;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
      position: relative;
    }
    
    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    .controls {
      position: fixed;
      bottom: 0;
      width: 100%;
      padding: 15px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      z-index: 10;
    }
    
    button {
      background: #4CAF50;
      border: none;
      color: white;
      padding: 10px 20px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 4px;
    }
    
    .detected-text {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 10px;
      border-radius: 5px;
      z-index: 10;
      max-width: 80%;
      font-size: 14px;
    }
    
    .decoded-overlay {
      position: absolute;
      background: rgba(255, 255, 255, 0.8);
      border-radius: 4px;
      padding: 5px 10px;
      font-weight: bold;
      z-index: 5;
    }
  </style>
</head>
<body>
  <div class="container">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
    <div class="detected-text" id="detected-text">No text detected</div>
  </div>
  
  <div class="controls">
    <button id="start-camera">Start Camera</button>
    <button id="toggle-camera">Switch Camera</button>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.0.3/tesseract.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      const startCameraButton = document.getElementById('start-camera');
      const toggleCameraButton = document.getElementById('toggle-camera');
      const detectedTextElement = document.getElementById('detected-text');
      
      let currentStream = null;
      let preferredCameraFacing = "environment"; // Start with back camera
      let overlayElements = [];
      
      // Initialize Tesseract worker
      const worker = Tesseract.createWorker();
      
      async function initTesseract() {
        await worker.load();
        await worker.loadLanguage('eng');
        await worker.initialize('eng');
      }
      
      initTesseract();
      
      // Start camera
      async function startCamera() {
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }
        
        try {
          const constraints = {
            video: {
              facingMode: preferredCameraFacing
            }
          };
          
          currentStream = await navigator.mediaDevices.getUserMedia(constraints);
          video.srcObject = currentStream;
          
          // Set canvas dimensions after video loads
          video.onloadedmetadata = () => {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            // Start processing frames
            processVideoFrames();
          };
          
        } catch (err) {
          console.error("Error starting camera:", err);
          detectedTextElement.textContent = "Camera error: " + err.message;
        }
      }
      
      // Toggle between front and back camera
      function toggleCamera() {
        preferredCameraFacing = preferredCameraFacing === "environment" ? "user" : "environment";
        startCamera();
      }
      
      // Decode shift cipher (shift 3)
      function decipherShift3(text) {
        return text.split('').map(char => {
          const code = char.charCodeAt(0);
          
          // Handle uppercase letters
          if (code >= 65 && code <= 90) {
            return String.fromCharCode(((code - 65 - 3 + 26) % 26) + 65);
          }
          
          // Handle lowercase letters
          if (code >= 97 && code <= 122) {
            return String.fromCharCode(((code - 97 - 3 + 26) % 26) + 97);
          }
          
          // Return non-alphabetic characters as is
          return char;
        }).join('');
      }
      
      // Create AR-like overlay for decoded text
      function createOverlay(original, decoded, x, y) {
        // Remove old overlays
        overlayElements.forEach(el => {
          if (el && el.parentNode) {
            el.parentNode.removeChild(el);
          }
        });
        overlayElements = [];
        
        // Create new overlay
        const overlay = document.createElement('div');
        overlay.className = 'decoded-overlay';
        overlay.textContent = decoded;
        overlay.style.left = `${x}px`;
        overlay.style.top = `${y}px`;
        document.querySelector('.container').appendChild(overlay);
        overlayElements.push(overlay);
      }
      
      // Process video frames to detect text
      async function processVideoFrames() {
        if (!video.paused && !video.ended) {
          // Draw current video frame to canvas
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          
          // Extract frame as image data
          const imageData = canvas.toDataURL('image/jpeg');
          
          try {
            // Recognize text in the image
            const { data } = await worker.recognize(imageData);
            
            if (data.text.trim() !== '') {
              // Update detected text display
              detectedTextElement.textContent = `Detected: ${data.text.trim()}`;
              
              // Process each word with confidence
              data.words.forEach(word => {
                if (word.confidence > 60) {  // Only process words with decent confidence
                  const originalText = word.text;
                  const decodedText = decipherShift3(originalText);
                  
                  // Create overlay at word position
                  const { x0, y0 } = word.bbox;
                  createOverlay(originalText, decodedText, x0, y0 - 30);
                }
              });
            }
          } catch (err) {
            console.error("Text recognition error:", err);
          }
        }
        
        // Continue processing frames
        requestAnimationFrame(processVideoFrames);
      }
      
      // Button event listeners
      startCameraButton.addEventListener('click', startCamera);
      toggleCameraButton.addEventListener('click', toggleCamera);
      
      // Clean up on page unload
      window.addEventListener('beforeunload', () => {
        if (currentStream) {
          currentStream.getTracks().forEach(track => track.stop());
        }
        worker.terminate();
      });
    });
  </script>
</body>
</html>